---
/**
 * Passivhaus Section
 *
 * Muestra 3 secciones (Passivhaus, Zonas Comunes, Interiores) con dos layouts diferentes:
 *
 * MOBILE: 3 cards apiladas con efecto sticky (cada card se queda fija mientras
 *         la siguiente la tapa al hacer scroll)
 *
 * DESKTOP: 1 vista fija con 3 elementos que se animan con scroll:
 *          - Izquierda: textos que se desplazan verticalmente
 *          - Centro: imágenes que se desplazan verticalmente
 *          - Derecha: tagline que cambia con transición fade+slide
 */
const { lang = "es" } = Astro.props;

const translations = await import(`../i18n/${lang}.json`);
const t = translations.passivhaus;

const sectionImages = [
  "/images/passivhaus-sections/passivhaus.webp",
  "/images/passivhaus-sections/zonas-comunes.webp",
  "/images/passivhaus-sections/interiores.webp",
];
---

<section class="passivhaus" id="passivhaus">
  <!-- MOBILE: 3 cards con efecto sticky stacking -->
  <div class="passivhaus__mobile">
    {t.sections.map((section, index) => (
      <article
        class="passivhaus__card"
        style={`background-image: url(${sectionImages[index]})`}
      >
        <div class="passivhaus__content">
          <h2 class="passivhaus__title">{section.title}</h2>
          <p class="passivhaus__description">{section.description}</p>
          <ul class="passivhaus__features">
            {section.features.map((feature) => <li>{feature}</li>)}
          </ul>
          <p class="passivhaus__closing">{section.closing}</p>
        </div>

        <div class="passivhaus__footer">
          <p class="passivhaus__tagline">{section.tagline}</p>
          <a href="#contact" class="passivhaus__cta">{t.cta}</a>
        </div>
      </article>
    ))}
  </div>

  <!-- DESKTOP: Vista única con scroll sincronizado -->
  <div class="passivhaus__desktop">
    <!-- Columna izquierda: textos animados -->
    <div class="passivhaus__texts">
      <div class="passivhaus__texts-track" data-scroll-track="texts">
        {t.sections.map((section) => (
          <div class="passivhaus__text-item">
            <h2 class="passivhaus__title">{section.title}</h2>
            <p class="passivhaus__description">{section.description}</p>
            <ul class="passivhaus__features">
              {section.features.map((feature) => <li>{feature}</li>)}
            </ul>
            <p class="passivhaus__closing">{section.closing}</p>
          </div>
        ))}
      </div>
    </div>

    <!-- Centro: imágenes animadas -->
    <div class="passivhaus__images">
      <div class="passivhaus__images-track" data-scroll-track="images">
        {sectionImages.map((src, index) => (
          <img
            src={src}
            alt={t.sections[index].title}
            class="passivhaus__image"
            loading="lazy"
          />
        ))}
      </div>
    </div>

    <!-- Columna derecha: taglines con transición -->
    <div class="passivhaus__sidebar">
      <div class="passivhaus__taglines">
        {t.sections.map((section, index) => (
          <p
            class={`passivhaus__tagline ${index === 0 ? "is-active" : ""}`}
            data-tagline-index={index}
          >
            {section.tagline}
          </p>
        ))}
      </div>
      <a href="#contact" class="passivhaus__cta">{t.cta}</a>
    </div>
  </div>
</section>

<style>
  /* =============================================
     BASE STYLES
     ============================================= */
  .passivhaus {
    background-color: var(--color-dark);
    color: var(--color-white);

    @media (min-width: 768px) {
      height: 300vh; /* Altura para permitir scroll en desktop */
    }
  }

  /* Tipografía compartida */
  .passivhaus__title {
    font-family: var(--font-heading);
    font-size: var(--font-size-h2);
    font-weight: 400;
    margin-bottom: var(--space-md);
  }

  .passivhaus__description,
  .passivhaus__features li,
  .passivhaus__closing {
    font-family: var(--font-body);
    font-size: var(--font-size-body);
    line-height: 1.6;
  }

  .passivhaus__features {
    padding-left: 1.2em;
    margin: 0;
  }

  .passivhaus__tagline {
    font-family: var(--font-heading);
    font-style: italic;
    margin: 0;
  }

  .passivhaus__cta {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--color-white);
    color: var(--color-white);
    text-decoration: none;
    text-align: center;
  }

  /* =============================================
     MOBILE LAYOUT
     ============================================= */
  .passivhaus__mobile {
    display: block;
  }

  .passivhaus__desktop {
    display: none;
  }

  .passivhaus__card {
    position: sticky;
    top: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    padding: var(--space-lg) var(--content-padding);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;

    /* Overlay oscuro para mejorar legibilidad */
    &::before {
      content: "";
      position: absolute;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.2);
      z-index: 0;
    }

    /* Contenido sobre el overlay */
    & > * {
      position: relative;
      z-index: 1;
    }
  }

  .passivhaus__footer {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-top: auto;
  }

  /* =============================================
     DESKTOP LAYOUT
     ============================================= */
  @media (min-width: 768px) {
    .passivhaus__mobile {
      display: none;
    }

    .passivhaus__desktop {
      display: block;
      position: sticky;
      top: 0;
      height: 100vh;
      padding: 0 var(--content-padding);
    }

    /* --- Columna izquierda: Textos --- */
    .passivhaus__texts {
      position: absolute;
      left: var(--content-padding);
      width: 35%;
      height: 100vh;
      overflow: hidden;
      z-index: 2;
    }

    .passivhaus__texts-track {
      display: flex;
      flex-direction: column;
    }

    .passivhaus__text-item {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* --- Centro: Imágenes --- */
    .passivhaus__images {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60%;
      aspect-ratio: 5 / 3;
      overflow: hidden;
      z-index: 1;

      /* Overlay sobre las imágenes */
      &::after {
        content: "";
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.2);
        pointer-events: none;
      }
    }

    .passivhaus__images-track {
      display: flex;
      flex-direction: column;
    }

    .passivhaus__image {
      width: 100%;
      aspect-ratio: 5 / 3;
      object-fit: cover;
    }

    /* --- Columna derecha: Sidebar --- */
    .passivhaus__sidebar {
      position: absolute;
      right: var(--content-padding);
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
      gap: var(--space-sm);
      z-index: 2;
    }

    .passivhaus__taglines {
      position: relative;
      width: 100%;
      min-width: 200px;
      height: 2em;
    }

    .passivhaus__taglines .passivhaus__tagline {
      position: absolute;
      top: 0;
      right: 0;
      white-space: nowrap;
      transform: translateY(100%);
      opacity: 0;
      transition:
        transform 0.2s ease-out,
        opacity 0.2s ease-out;
    }

    .passivhaus__taglines .passivhaus__tagline.is-active {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>

<script>
  /**
   * Inicializa las animaciones de scroll para la sección Passivhaus (solo desktop)
   *
   * Funcionamiento:
   * 1. La sección tiene altura 300vh para crear espacio de scroll
   * 2. El contenedor desktop es sticky (100vh) y se queda fijo
   * 3. Al hacer scroll, calculamos el progreso (0-1) dentro de la sección
   * 4. Ese progreso mueve los tracks de textos e imágenes con translateY
   * 5. Los taglines cambian con una transición CSS cuando el índice cambia
   */
  function initPassivhausScroll() {
    const section = document.querySelector(".passivhaus");
    const desktop = document.querySelector(".passivhaus__desktop");

    if (!section || !desktop || window.innerWidth < 768) return;

    // Elementos animables
    const textsTrack = desktop.querySelector(".passivhaus__texts-track");
    const imagesTrack = desktop.querySelector(".passivhaus__images-track");
    const taglines = desktop.querySelectorAll(".passivhaus__tagline");

    if (!textsTrack || !imagesTrack || !taglines.length) return;

    // Referencias para calcular alturas
    const textItems = textsTrack.querySelectorAll(".passivhaus__text-item");
    const images = imagesTrack.querySelectorAll(".passivhaus__image");
    const totalSections = textItems.length;

    if (totalSections === 0) return;

    let currentTaglineIndex = 0;

    function handleScroll() {
      // Solo ejecutar en desktop
      if (window.innerWidth < 768) return;

      // Calcular progreso del scroll dentro de la sección
      const sectionRect = section.getBoundingClientRect();
      const scrollableDistance = section.offsetHeight - window.innerHeight;
      const scrolled = -sectionRect.top;
      const progress = Math.max(0, Math.min(1, scrolled / scrollableDistance));

      // Convertir progreso (0-1) a índice de sección (0 a totalSections-1)
      const sectionProgress = progress * (totalSections - 1);

      // Animar textos
      const textItemHeight = textItems[0]?.offsetHeight || 0;
      textsTrack.style.transform = `translateY(-${sectionProgress * textItemHeight}px)`;

      // Animar imágenes
      const imageHeight = images[0]?.offsetHeight || 0;
      imagesTrack.style.transform = `translateY(-${sectionProgress * imageHeight}px)`;

      // Cambiar tagline activo (con transición CSS)
      const newIndex = Math.round(sectionProgress);
      if (newIndex !== currentTaglineIndex && taglines[newIndex]) {
        taglines[currentTaglineIndex]?.classList.remove("is-active");
        taglines[newIndex].classList.add("is-active");
        currentTaglineIndex = newIndex;
      }
    }

    // Event listeners
    window.addEventListener("scroll", handleScroll, { passive: true });
    window.addEventListener("resize", handleScroll, { passive: true });

    // Ejecutar una vez al inicio
    handleScroll();
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", initPassivhausScroll);
</script>
