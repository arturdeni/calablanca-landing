---
import VideoModal from "./VideoModal.astro";

const { lang = "es", vimeoId = "1019191082" } = Astro.props;

const translations = await import(`../i18n/${lang}.json`);
const t = translations.timeline;
const c = translations.contact;

// Current stage (0-indexed, editable here)
// 0 = Comercialización, 1 = Permisos Obra, 2 = Inicio obra, 3 = Fin Obra, 4 = Entrega de llaves
const currentStage = t.currentStage ?? 1;
---

<section class="timeline-section" id="timeline">
  <div class="timeline-section__container">
    <!-- Header -->
    <header class="timeline-section__header">
      <h2 class="timeline-section__title" data-text-reveal="words">{t.title}</h2>
      <button
        class="timeline-section__video-btn"
        type="button"
        data-vimeo-lightbox-control="open"
        data-vimeo-lightbox-id={vimeoId}
      >
        {t.videoButton}
      </button>
    </header>

    <!-- Timeline -->
    <div
      class="timeline-section__progress"
      style={`--current-stage: ${currentStage}; --total-stages: ${t.stages.length}`}
    >
      <div class="timeline-section__track">
        <div class="timeline-section__track-bg"></div>
        <div class="timeline-section__track-fill"></div>
        <!-- SVG for zigzag lines (mobile only) -->
        <svg class="timeline-section__track-svg" preserveAspectRatio="none">
          <!-- Lines will be drawn via JS -->
        </svg>
      </div>
      <div class="timeline-section__stages">
        {
          t.stages.map((stage, index) => (
            <div
              class={`timeline-section__stage ${index < currentStage ? "timeline-section__stage--completed" : ""} ${index === currentStage ? "timeline-section__stage--active" : ""}`}
            >
              <span class="timeline-section__stage-dot" />
              <span class="timeline-section__stage-label">{stage}</span>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<!-- Video Modal -->
<VideoModal vimeoId={vimeoId} />

<!-- Contact Section -->
<section class="contact-section" id="contact">
  <div class="contact-section__container">
    <!-- Left: Form -->
    <div class="contact-section__form-wrapper">
      <!-- Header row: texts left, contact info right -->
      <div class="contact-section__header">
        <div class="contact-section__header-text">
          <h2 class="contact-section__title" data-text-reveal="words">{c.title}</h2>
          <p class="contact-section__intro">{c.intro}</p>
          <p class="contact-section__subtitle">{c.subtitle}</p>
        </div>

        <div class="contact-section__contact-info">
          <span class="contact-section__contact-label">{c.contactLabel}</span>
          <a href={`mailto:${c.email}`} class="contact-section__contact-link"
            >{c.email}</a
          >
          <a
            href={`tel:${c.phone.replace(/\s/g, "")}`}
            class="contact-section__contact-link">{c.phone}</a
          >
        </div>
      </div>

      <form class="contact-section__form" id="contact-form">
        <div class="contact-section__form-row">
          <div class="contact-section__form-group">
            <label for="firstName" class="contact-section__label"
              >{c.form.firstName}*</label
            >
            <input
              type="text"
              id="firstName"
              name="firstName"
              required
              class="contact-section__input"
            />
          </div>
          <div class="contact-section__form-group">
            <label for="lastName" class="contact-section__label"
              >{c.form.lastName}*</label
            >
            <input
              type="text"
              id="lastName"
              name="lastName"
              required
              class="contact-section__input"
            />
          </div>
        </div>

        <div class="contact-section__form-row">
          <div class="contact-section__form-group">
            <label for="email" class="contact-section__label"
              >{c.form.email}*</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              class="contact-section__input"
            />
          </div>
          <div class="contact-section__form-group">
            <label for="phone" class="contact-section__label"
              >{c.form.phone}*</label
            >
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="contact-section__input"
            />
          </div>
        </div>

        <div class="contact-section__checkboxes">
          <label class="contact-section__checkbox-label">
            <input
              type="checkbox"
              name="privacy"
              required
              class="contact-section__checkbox"
            />
            <span
              >{c.form.privacy}
              <a href="/privacy" class="contact-section__privacy-link"
                >{c.form.privacyLink}</a
              >.</span
            >
          </label>
          <label class="contact-section__checkbox-label">
            <input
              type="checkbox"
              name="commercial"
              class="contact-section__checkbox"
            />
            <span>{c.form.commercial}</span>
          </label>
        </div>

        <!-- Honeypot field (antispam) - hidden from users -->
        <input
          type="text"
          name="website"
          class="contact-section__honeypot"
          tabindex="-1"
          autocomplete="off"
        />
        <!-- Timestamp for time-based validation -->
        <input type="hidden" name="formLoadedAt" id="formLoadedAt" value="" />

        <button type="submit" class="contact-section__submit"
          >{c.form.submit}</button
        >
      </form>
    </div>

    <!-- Right: Image -->
    <div class="contact-section__image-wrapper">
      <img
        src="/images/passivhaus-sections/interiores.webp"
        alt="Interior de Cala Blanca Residences"
        class="contact-section__image"
        loading="lazy"
      />
    </div>
  </div>
</section>

<style>
  /* ============================================
     TIMELINE SECTION
     ============================================ */
  .timeline-section {
    padding: var(--space-lg) 0;
    background-color: var(--color-white);
  }

  .timeline-section__container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding);
  }

  /* Header */
  .timeline-section__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
  }

  .timeline-section__title {
    margin: 0;
  }

  .timeline-section__video-btn {
    padding: var(--space-xs) var(--space-xs);
    border: 1px solid var(--color-primary);
    border-radius: 8px;
    font-family: var(--font-heading);
    font-size: 0.875rem;
    background: transparent;
    color: var(--color-primary);
    cursor: pointer;
    transition: all var(--transition-fast);

    &:hover {
      background-color: var(--color-primary);
      color: var(--color-white);
    }
  }

  /* Timeline Progress */
  .timeline-section__progress {
    position: relative;
    /* Height for stepped layout: 3 rows of dots + labels */
    height: auto;
    min-height: 180px;
  }

  /* Track container - zigzag SVG path for mobile */
  .timeline-section__track {
    position: absolute;
    inset: 0;
    overflow: visible;
  }

  .timeline-section__track-bg,
  .timeline-section__track-fill {
    display: none;
  }

  /* SVG zigzag line */
  .timeline-section__track-svg {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: visible;
  }

  .timeline-section__track-svg line {
    stroke-width: 2;
  }

  .timeline-section__track-svg .track-bg {
    stroke: #e0e0e0;
  }

  .timeline-section__track-svg .track-fill {
    stroke: var(--color-primary);
  }

  /* Stages container - stepped layout for mobile (3 rows) */
  .timeline-section__stages {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto auto auto;
    row-gap: var(--space-md);
    position: relative;
    z-index: 2;
    height: 100%;
  }

  .timeline-section__stage {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }

  /* Row 1: Point 1 (left), Point 2 (center) */
  .timeline-section__stage:nth-child(1) {
    grid-column: 1;
    grid-row: 1;
    align-items: flex-start;
  }

  .timeline-section__stage:nth-child(2) {
    grid-column: 2;
    grid-row: 1;
    align-items: center;
  }

  /* Row 2: Point 3 (right) */
  .timeline-section__stage:nth-child(3) {
    grid-column: 3;
    grid-row: 2;
    align-items: flex-end;
  }

  /* Row 3: Point 4 (center), Point 5 (left) */
  .timeline-section__stage:nth-child(4) {
    grid-column: 2;
    grid-row: 3;
    align-items: center;
  }

  .timeline-section__stage:nth-child(5) {
    grid-column: 1;
    grid-row: 3;
    align-items: flex-start;
  }

  .timeline-section__stage-dot {
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-primary);
    background-color: var(--color-white);
    flex-shrink: 0;
    transition: all var(--transition-fast);
  }

  .timeline-section__stage--completed .timeline-section__stage-dot,
  .timeline-section__stage--active .timeline-section__stage-dot {
    background-color: var(--color-primary);
  }

  .timeline-section__stage-label {
    font-size: 0.75rem;
    color: var(--color-primary);
    text-align: center;
    max-width: 80px;
    line-height: 1.3;
    white-space: pre-line;
  }

  /* Labels below dots for all stages in mobile */
  .timeline-section__stage-label {
    margin-top: var(--space-xs);
  }

  /* ============================================
     CONTACT SECTION
     ============================================ */
  .contact-section {
    background-color: var(--color-white);
  }

  .contact-section__container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding);
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  /* Form wrapper */
  .contact-section__form-wrapper {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  /* Header (title/intro + contact info) */
  .contact-section__header {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .contact-section__header-text {
    display: flex;
    flex-direction: column;
  }

  .contact-section__title {
    margin: 0;
  }

  .contact-section__intro {
    font-size: var(--font-size-body);
    color: var(--color-primary);
    margin: var(--space-md) 0 0;
    max-width: 400px;
  }

  .contact-section__subtitle {
    font-size: var(--font-size-body);
    color: var(--color-primary);
    margin: var(--space-xs) 0 0;
  }

  /* Contact info */
  .contact-section__contact-info {
    display: flex;
    flex-direction: column;
  }

  .contact-section__contact-label {
    font-weight: 600;
    color: var(--color-primary);
  }

  .contact-section__contact-link {
    font-size: var(--font-size-body);
    color: var(--color-primary);

    &:hover {
      opacity: 0.7;
    }
  }

  /* Form */
  .contact-section__form {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    margin-top: var(--space-md);
  }

  .contact-section__form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
  }

  .contact-section__form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .contact-section__label {
    font-size: 0.875rem;
    color: var(--color-primary);
  }

  .contact-section__input {
    padding: var(--space-sm);
    border: 1px solid #e0e0e0;
    border-radius: 0;
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--color-primary);
    background-color: var(--color-white);
    transition: border-color var(--transition-fast);

    &:focus {
      outline: none;
      border-color: var(--color-primary);
    }
  }

  /* Checkboxes */
  .contact-section__checkboxes {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .contact-section__checkbox-label {
    display: flex;
    align-items: flex-start;
    gap: var(--space-xs);
    font-size: var(--font-size-body);
    cursor: pointer;
  }

  .contact-section__checkbox {
    width: 16px;
    height: 16px;
    margin-top: 2px;
    accent-color: var(--color-primary);
    cursor: pointer;
  }

  .contact-section__privacy-link {
    text-decoration: underline;

    &:hover {
      opacity: 0.7;
    }
  }

  /* Honeypot - hidden from users, visible to bots */
  .contact-section__honeypot {
    position: absolute;
    left: -9999px;
    opacity: 0;
    height: 0;
    width: 0;
    z-index: -1;
  }

  /* Submit button */
  .contact-section__submit {
    padding: var(--space-sm) var(--space-lg);
    border: 1px solid var(--color-primary);
    border-radius: 8px;
    font-family: var(--font-heading);
    font-size: 0.875rem;
    background: transparent;
    color: var(--color-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
    align-self: flex-start;

    &:hover {
      background-color: var(--color-primary);
      color: var(--color-white);
    }
  }

  /* Image wrapper */
  .contact-section__image-wrapper {
    display: none;
  }

  .contact-section__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* ============================================
     TABLET AND UP - Back to horizontal timeline
     ============================================ */
  @media (min-width: 768px) {
    .timeline-section {
      padding: var(--space-xl) 0;
    }

    .timeline-section__video-btn {
      padding: var(--space-xs) var(--space-md);
    }

    .timeline-section__progress {
      height: auto;
    }

    .timeline-section__track {
      position: absolute;
      top: 9px;
      left: 10px;
      right: 10px;
      height: 2px;
    }

    .timeline-section__track-bg {
      display: block;
      position: absolute;
      inset: 0;
      background-color: #e0e0e0;
    }

    .timeline-section__track-fill {
      display: block;
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background-color: var(--color-primary);
      width: calc(var(--current-stage) / (var(--total-stages) - 1) * 100%);
    }

    .timeline-section__track-svg {
      display: none;
    }

    .timeline-section__stages {
      display: flex;
      justify-content: space-between;
      height: auto;
      align-items: stretch;
    }

    .timeline-section__stage {
      flex-direction: column;
      grid-column: auto;
      grid-row: auto;
    }

    .timeline-section__stage:nth-child(n) {
      align-items: center;
    }

    .timeline-section__stage:first-child {
      align-items: flex-start;
    }

    .timeline-section__stage:last-child {
      align-items: flex-end;
    }

    .timeline-section__stage-dot {
      width: 20px;
      height: 20px;
    }

    .timeline-section__stage-label {
      font-size: 0.875rem;
      max-width: 120px;
      margin-top: var(--space-xs);
      margin-bottom: 0;
    }

    .timeline-section__stage:first-child .timeline-section__stage-label {
      text-align: left;
    }

    .timeline-section__stage:last-child .timeline-section__stage-label {
      text-align: right;
    }

    .contact-section {
      padding: var(--space-xl) 0;
    }

    .contact-section__form-row {
      grid-template-columns: 1fr 1fr;
    }

    /* Header: two columns with contact-info at bottom right */
    .contact-section__header {
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-end;
      gap: var(--space-lg);
    }

    .contact-section__contact-info {
      margin-top: 0;
      flex-shrink: 0;
    }

    .contact-section__submit {
      align-self: flex-end;
    }
  }

  /* ============================================
     DESKTOP
     ============================================ */
  @media (min-width: 1080px) {
    .timeline-section__stage-label {
      font-size: 1rem;
      max-width: 140px;
    }

    .contact-section__container {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-xl);
      align-items: start;
      padding: 0 0 0 var(--content-padding);
    }

    .contact-section__image-wrapper {
      display: block;
      height: 100%;
      overflow: hidden;
    }
  }
</style>

<script>
  // Timeline stepped lines for mobile (rectangular path)
  function drawZigzagLines() {
    const svg = document.querySelector('.timeline-section__track-svg');
    const stages = document.querySelectorAll('.timeline-section__stage');
    const progress = document.querySelector('.timeline-section__progress');

    if (!svg || stages.length < 2 || !progress) return;

    // Only draw on mobile (< 768px)
    if (window.innerWidth >= 768) {
      svg.innerHTML = '';
      return;
    }

    const progressRect = progress.getBoundingClientRect();
    const currentStage = parseInt(getComputedStyle(progress).getPropertyValue('--current-stage')) || 0;

    // Get all dot positions
    const dots = [];
    stages.forEach((stage) => {
      const dot = stage.querySelector('.timeline-section__stage-dot');
      if (dot) {
        const rect = dot.getBoundingClientRect();
        dots.push({
          x: rect.left + rect.width / 2 - progressRect.left,
          y: rect.top + rect.height / 2 - progressRect.top
        });
      }
    });

    if (dots.length < 5) return;

    let linesHtml = '';

    // Helper to draw a path segment (background and fill if completed)
    function drawSegment(points, segmentIndex) {
      const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

      // Background line (gray)
      linesHtml += `<path d="${pathData}" stroke="#e0e0e0" stroke-width="2" fill="none" />`;

      // Filled line (only for completed segments)
      if (segmentIndex < currentStage) {
        linesHtml += `<path d="${pathData}" stroke="var(--color-primary, #1a365d)" stroke-width="2" fill="none" />`;
      }
    }

    // Segment 1→2: horizontal line (same row)
    drawSegment([dots[0], dots[1]], 0);

    // Segment 2→3: from center to right-bottom
    // Go horizontal first to x of dot3, then vertical down to dot3
    drawSegment([
      dots[1],
      { x: dots[2].x, y: dots[1].y },  // horizontal to x of dot3
      dots[2]                           // vertical down to dot3
    ], 1);

    // Segment 3→4: from right to center-bottom
    // Go vertical down first to y of dot4, then horizontal left to dot4
    drawSegment([
      dots[2],
      { x: dots[2].x, y: dots[3].y },  // vertical down to y of dot4
      dots[3]                           // horizontal left to dot4
    ], 2);

    // Segment 4→5: horizontal line (same row)
    drawSegment([dots[3], dots[4]], 3);

    svg.innerHTML = linesHtml;
  }

  // Calculate track fill width for desktop (to reach exact bullet position)
  function updateTrackFill() {
    const track = document.querySelector('.timeline-section__track');
    const trackFill = document.querySelector('.timeline-section__track-fill');
    const stages = document.querySelectorAll('.timeline-section__stage');
    const progress = document.querySelector('.timeline-section__progress');

    if (!track || !trackFill || !stages.length || !progress) return;

    // Only for desktop (>= 768px)
    if (window.innerWidth < 768) return;

    const currentStage = parseInt(getComputedStyle(progress).getPropertyValue('--current-stage')) || 0;

    if (currentStage === 0) {
      trackFill.style.width = '0%';
      return;
    }

    const trackRect = track.getBoundingClientRect();
    const activeDot = stages[currentStage]?.querySelector('.timeline-section__stage-dot');

    if (!activeDot) return;

    const dotRect = activeDot.getBoundingClientRect();
    const dotCenter = dotRect.left + dotRect.width / 2;
    const fillWidth = dotCenter - trackRect.left;

    trackFill.style.width = `${fillWidth}px`;
  }

  // Draw on load and resize (with delay to ensure layout is ready)
  function initTimeline() {
    // Use requestAnimationFrame to wait for layout
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        drawZigzagLines();
        updateTrackFill();
      });
    });
  }

  // Run on DOMContentLoaded or immediately if already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTimeline);
  } else {
    initTimeline();
  }

  // Also run on window load (for images/fonts that might affect layout)
  window.addEventListener('load', () => {
    drawZigzagLines();
    updateTrackFill();
  });

  // Redraw on resize with debounce
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      drawZigzagLines();
      updateTrackFill();
    }, 100);
  });

  // Antispam: Set timestamp when form loads
  const formLoadedAt = document.querySelector('#formLoadedAt');
  if (formLoadedAt instanceof HTMLInputElement) {
    formLoadedAt.value = Date.now().toString();
  }

  // Form validation with antispam checks
  const contactForm = document.querySelector('#contact-form');
  if (contactForm instanceof HTMLFormElement) {
    contactForm.addEventListener('submit', (e) => {
      const honeypot = contactForm.querySelector('[name="website"]');
      const timestamp = contactForm.querySelector('[name="formLoadedAt"]');

      // Check honeypot (should be empty)
      if (honeypot instanceof HTMLInputElement && honeypot.value) {
        e.preventDefault();
        return;
      }

      // Check time elapsed (minimum 3 seconds to fill form)
      if (timestamp instanceof HTMLInputElement && timestamp.value) {
        const elapsed = Date.now() - parseInt(timestamp.value, 10);
        if (elapsed < 3000) {
          e.preventDefault();
          return;
        }
      }
    });
  }
</script>
