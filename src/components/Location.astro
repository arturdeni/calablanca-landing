---
const { lang = "es" } = Astro.props;

const translations = await import(`../i18n/${lang}.json`);
const t = translations.location;

// API key desde variable de entorno
const googleMapsApiKey = import.meta.env.PUBLIC_GOOGLE_MAPS_API_KEY || "";
---

<section class="location" id="location">
  <div class="location__container">
    <!-- Header -->
    <header class="location__header">
      <h2 class="location__title" data-text-reveal="lines">{t.title}</h2>
    </header>

    <!-- Content -->
    <div class="location__content">
      <h3 class="location__subtitle" data-text-reveal="lines">{t.subtitle}</h3>

      <div class="location__info">
        <p class="location__description" data-text-reveal="lines">
          {t.description}
        </p>

        <div class="location__distances">
          <h4 class="location__distances-title" data-text-reveal="lines">{t.distancesTitle}</h4>
          <ul class="location__distances-list" data-text-reveal="lines">
            <li>{t.distances.beach}</li>
            <li>{t.distances.airport}</li>
            <li>{t.distances.services}</li>
          </ul>
        </div>
      </div>

      <a href="#contact" class="location__cta">{t.cta}</a>
    </div>

    <!-- Map - Desktop: imagen estática -->
    <div class="location__map-wrapper location__map-wrapper--desktop">
      <img
        src="/images/location-map.webp"
        alt={t.mapAlt}
        class="location__map-image"
        loading="lazy"
      />
    </div>

    <!-- Map - Mobile: Google Maps interactivo minimalista -->
    <div class="location__map-wrapper location__map-wrapper--mobile">
      <div id="location-map" class="location__google-map"></div>
      <!-- Marcador HTML animable con GSAP -->
      <div class="location__marker" id="location-marker">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="52" viewBox="0 0 40 52">
          <path d="M20 0C8.954 0 0 8.954 0 20c0 11.046 20 32 20 32s20-20.954 20-32C40 8.954 31.046 0 20 0z" fill="#131E30"/>
          <text x="20" y="24" text-anchor="middle" fill="white" font-family="Arial, sans-serif" font-size="14" font-weight="bold">AX</text>
        </svg>
      </div>
    </div>
  </div>
</section>

<style>
  .location {
    padding: var(--space-lg) 0;
    background-color: var(--color-white);
  }

  .location__container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--content-padding);
  }

  /* Header */
  .location__header {
    margin-bottom: var(--space-md);
  }

  .location__title {
    margin: 0;
  }

  /* Content grid */
  .location__content {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .location__subtitle {
    font-family: var(--font-heading);
    font-size: clamp(1.25rem, 3vw, 1.75rem);
    font-weight: 400;
    margin: 0;
  }

  .location__info {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .location__description {
    font-size: var(--font-size-body);
    color: var(--color-primary);
    margin: 0;
  }

  /* Distances */
  .location__distances {
    margin-top: var(--space-xs);
  }

  .location__distances-title {
    font-family: var(--font-body);
    font-size: var(--font-size-body);
    font-weight: 400;
    margin: 0 0 var(--space-xs);
  }

  .location__distances-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: var(--font-size-body);

    & li {
      position: relative;
      padding-left: 1em;

      &::before {
        content: "·";
        position: absolute;
        left: 0;
      }
    }
  }

  /* CTA Button */
  .location__cta {
    display: inline-block;
    padding: var(--space-xs) var(--space-md);
    border: 1px solid var(--color-primary);
    border-radius: 8px;
    font-family: var(--font-heading);
    font-size: 0.875rem;
    text-align: center;
    transition: all var(--transition-fast);
    align-self: flex-start;

    &:hover {
      background-color: var(--color-primary);
      color: var(--color-white);
      opacity: 1;
    }
  }

  /* Map */
  .location__map-wrapper {
    width: 100%;
  }

  .location__map-image {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Mobile: mostrar Google Maps, ocultar imagen */
  .location__map-wrapper--desktop {
    display: none;
  }

  .location__map-wrapper--mobile {
    display: block;
  }

  .location__google-map {
    width: 100%;
    height: 300px;
    background-color: var(--color-cream);
  }

  /* Marcador HTML animable */
  .location__marker {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -100%);
    z-index: 10;
    pointer-events: none;
    opacity: 0;
  }

  .location__map-wrapper--mobile {
    position: relative;
  }

  /* Tablet and up */
  @media (min-width: 768px) {
    .location {
      padding: var(--space-xl) 0;
    }

    .location__content {
      grid-template-columns: 4fr 2fr;
      grid-template-rows: auto auto;
      align-items: start;
      gap: var(--space-md);
    }

    .location__subtitle {
      grid-column: 1;
      grid-row: 1;
    }

    .location__info {
      grid-column: 1;
      grid-row: 2;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }

    .location__cta {
      align-self: flex-end;
      grid-column: 2;
      grid-row: 2;
      justify-self: end;
    }

    .location__distances {
      margin-top: 0;
    }

    /* Desktop: mostrar imagen, ocultar Google Maps */
    .location__map-wrapper--desktop {
      display: block;
    }

    .location__map-wrapper--mobile {
      display: none;
    }
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Exponer gsap globalmente para el script inline
  window.gsap = gsap;
</script>

<script define:vars={{ googleMapsApiKey }}>
  // Solo cargar Google Maps en mobile
  function isMobile() {
    return window.innerWidth < 768;
  }

  // Estilos minimalistas para el mapa (grayscale, sin etiquetas excesivas)
  const mapStyles = [
    {
      featureType: "all",
      elementType: "geometry",
      stylers: [{ saturation: -100 }]
    },
    {
      featureType: "all",
      elementType: "labels.text.fill",
      stylers: [{ color: "#666666" }]
    },
    {
      featureType: "all",
      elementType: "labels.text.stroke",
      stylers: [{ visibility: "off" }]
    },
    {
      featureType: "administrative",
      elementType: "labels",
      stylers: [{ visibility: "simplified" }]
    },
    {
      featureType: "poi",
      stylers: [{ visibility: "off" }]
    },
    {
      featureType: "transit",
      stylers: [{ visibility: "off" }]
    },
    {
      featureType: "road",
      elementType: "labels.icon",
      stylers: [{ visibility: "off" }]
    },
    {
      featureType: "water",
      elementType: "geometry.fill",
      stylers: [{ color: "#e0e0e0" }]
    }
  ];

  // Coordenadas de Cala Blanca (Passeig Isaac Albéniz, 11, Sitges)
  const LOCATION = { lat: 41.2473, lng: 1.80435 };

  function initMap() {
    const mapContainer = document.getElementById("location-map");
    if (!mapContainer) return;

    new google.maps.Map(mapContainer, {
      center: LOCATION,
      zoom: 15,
      styles: mapStyles,
      disableDefaultUI: true,      // Sin controles
      gestureHandling: "cooperative", // Scroll normal, pinch para zoom
      backgroundColor: "#f5f5f5"
    });

    // Animar el marcador HTML con GSAP
    animateMarker();
  }

  function animateMarker() {
    const marker = document.getElementById("location-marker");
    if (!marker || !window.gsap) return;

    gsap.fromTo(marker,
      {
        opacity: 0,
        y: -50
      },
      {
        opacity: 1,
        y: 0,
        duration: 0.8,
        ease: "bounce.out",
        scrollTrigger: {
          trigger: marker,
          start: "top 80%",
          once: true
        }
      }
    );
  }

  function loadGoogleMaps() {
    if (!googleMapsApiKey) {
      console.warn("Google Maps API key not configured");
      return;
    }

    // Evitar cargar múltiples veces
    if (window.google?.maps) {
      initMap();
      return;
    }

    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initLocationMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }

  // Callback global para Google Maps
  window.initLocationMap = initMap;

  // Cargar solo en mobile
  if (isMobile()) {
    // Cargar cuando el elemento sea visible (intersection observer)
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          loadGoogleMaps();
          observer.disconnect();
        }
      });
    }, { rootMargin: "100px" });

    const mapWrapper = document.querySelector(".location__map-wrapper--mobile");
    if (mapWrapper) {
      observer.observe(mapWrapper);
    }
  }
</script>
