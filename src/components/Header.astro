---
const { lang = 'es' } = Astro.props;
import { useTranslations } from '../i18n';
const t = useTranslations(lang);

const isEnglish = lang === 'en';
const toggleLangUrl = isEnglish ? '/' : '/en/';
---

<!-- Header principal (visible siempre, nav desktop solo >= 1220px) -->
<header class="header">
  <div class="container">
    <div class="header__inner">
      <a href={`/${lang === 'en' ? 'en/' : ''}`} class="header__logo">
        <img src="/images/header-logo.webp" alt="Cala Blanca Residences" class="header__logo-img" />
      </a>

      <nav class="header__nav">
        <ul class="header__nav-list">
          <li><a href="#residence">{t('nav.residence')}</a></li>
          <li><a href="#characteristics">{t('nav.characteristics')}</a></li>
          <li><a href="#location">{t('nav.location')}</a></li>
          <li><a href="#houses">{t('nav.houses')}</a></li>
          <li><a href="#contact">{t('nav.contact')}</a></li>
          <li><a href={toggleLangUrl}>{isEnglish ? 'ES' : 'EN'}</a></li>
        </ul>
      </nav>
    </div>
  </div>
</header>

<!-- Mobile logo (solo < 1220px) - Posición inicial, se va con scroll -->
<div class="mobile-logo">
  <a href={`/${lang === 'en' ? 'en/' : ''}`} class="mobile-logo__link">
    <img src="/images/header-logo.webp" alt="Cala Blanca Residences" />
  </a>
</div>

<!-- Mobile hamburger (solo < 1220px) - Siempre fijo -->
<div class="mobile-bar">
  <button data-navigation-toggle="toggle" class="mobile-bar__hamburger" aria-label="Menu">
    <div class="mobile-bar__hamburger-line"></div>
    <div class="mobile-bar__hamburger-line"></div>
    <div class="mobile-bar__hamburger-line"></div>
  </button>
</div>

<!-- Panel fullscreen mobile (solo < 1220px) -->
<nav data-navigation-status="not-active" class="mobile-nav">
  <div class="mobile-nav__tile">
    <ul class="mobile-nav__list">
      <li class="mobile-nav__item">
        <a href="#residence" data-navigation-toggle="close" class="mobile-nav__link">
          <span class="mobile-nav__link-text">{t('nav.residence')}</span>
        </a>
      </li>
      <li class="mobile-nav__item">
        <a href="#characteristics" data-navigation-toggle="close" class="mobile-nav__link">
          <span class="mobile-nav__link-text">{t('nav.characteristics')}</span>
        </a>
      </li>
      <li class="mobile-nav__item">
        <a href="#location" data-navigation-toggle="close" class="mobile-nav__link">
          <span class="mobile-nav__link-text">{t('nav.location')}</span>
        </a>
      </li>
      <li class="mobile-nav__item">
        <a href="#houses" data-navigation-toggle="close" class="mobile-nav__link">
          <span class="mobile-nav__link-text">{t('nav.houses')}</span>
        </a>
      </li>
      <li class="mobile-nav__item">
        <a href="#contact" data-navigation-toggle="close" class="mobile-nav__link">
          <span class="mobile-nav__link-text">{t('nav.contact')}</span>
        </a>
      </li>
    </ul>
    <div class="mobile-nav__bottom">
      <a href={toggleLangUrl} class="mobile-nav__lang">{isEnglish ? 'ES' : 'EN'}</a>
    </div>
  </div>
</nav>

<style>
  /* ================================
     HEADER DESKTOP (>= 1220px)
     ================================ */
  .header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    transition: transform 0.3s ease;
    display: none;
  }

  .header--top {
    mix-blend-mode: normal;
  }

  .header--top .header__nav-list a {
    color: var(--color-white);
  }

  .header--scrolled {
    mix-blend-mode: exclusion;
  }

  .header--hidden {
    transform: translateY(-100%);
  }

  .header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-md) 0;
    gap: var(--space-md);
  }

  .header__logo-img {
    height: 4rem;
    width: auto;
  }

  .header__nav-list {
    display: flex;
    gap: var(--space-md);
    list-style: none;
    align-items: center;
  }

  .header__nav-list a {
    font-family: var(--font-heading);
    font-size: var(--font-size-body);
    font-weight: 400;
    color: #e0e0e0;
    transition: color var(--transition-fast), opacity var(--transition-fast);

    &:hover {
      opacity: 0.8;
    }
  }

  /* ================================
     MOBILE LOGO (< 1220px)
     Posición inicial, se va con scroll
     ================================ */
  .mobile-logo {
    position: absolute;
    top: 0;
    left: 0;
    padding: var(--space-sm);
    z-index: 100;
  }

  .mobile-logo__link {
    display: flex;
    align-items: center;
    margin-top: 15px;
  }

  .mobile-logo__link img {
    height: 4rem;
    width: auto;
  }

  /* ================================
     MOBILE BAR (< 1220px)
     Solo hamburguesa, siempre fijo
     ================================ */
  .mobile-bar {
    position: fixed;
    top: 0;
    right: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    padding: var(--space-md);
  }

  /* Estado inicial: sin blend, blanco puro */
  .mobile-bar--top {
    mix-blend-mode: normal;
  }

  /* Estado scrolled: con blend para contraste */
  .mobile-bar--scrolled {
    mix-blend-mode: exclusion;
  }

  /* Hamburger */
  .mobile-bar__hamburger {
    color: var(--color-white);
    cursor: pointer;
    background-color: transparent;
    border: none;
    justify-content: center;
    align-items: center;
    width: 3em;
    height: 3em;
    display: flex;
    position: relative;
    overflow: hidden;
  }

  .mobile-bar__hamburger-line {
    background-color: currentColor;
    width: 2em;
    height: 2px;
    position: absolute;
    transform: translate(0, 0) rotate(0.001deg);
    transition: transform 0.5s cubic-bezier(.7, 0, .3, 1);
  }

  .mobile-bar__hamburger-line:nth-child(1) {
    transform: translate(0, -0.45em) scale(1, 1) rotate(0.001deg);
  }

  .mobile-bar__hamburger-line:nth-child(3) {
    transform: translate(0, 0.45em) scale(1, 1) rotate(0.001deg);
  }

  /* Hamburger Hover */
  .mobile-bar__hamburger:hover .mobile-bar__hamburger-line:nth-child(1) {
    transform: translate(0, -0.45em) scale(0.5, 1) rotate(0.001deg);
  }

  .mobile-bar__hamburger:hover .mobile-bar__hamburger-line:nth-child(3) {
    transform: translate(0, 0.45em) scale(0.5, 1) rotate(0.001deg);
  }

  /* Hamburger activo (X) */
  .mobile-bar--menu-open .mobile-bar__hamburger-line:nth-child(1) {
    transform: translate(0, 0) rotate(45deg) scale(1, 1);
  }

  .mobile-bar--menu-open .mobile-bar__hamburger-line:nth-child(2) {
    transform: translate(-150%, 0) rotate(0.001deg) scale(1, 1);
  }

  .mobile-bar--menu-open .mobile-bar__hamburger-line:nth-child(3) {
    transform: translate(0, 0) rotate(-45deg) scale(1, 1);
  }

  /* Hamburger Hover cuando activo */
  .mobile-bar--menu-open .mobile-bar__hamburger:hover .mobile-bar__hamburger-line:nth-child(1) {
    transform: translate(0, 0) rotate(45deg) scale(0.7, 1);
  }

  .mobile-bar--menu-open .mobile-bar__hamburger:hover .mobile-bar__hamburger-line:nth-child(3) {
    transform: translate(0, 0) rotate(-45deg) scale(0.7, 1);
  }

  /* ================================
     MOBILE NAV PANEL (< 1220px)
     ================================ */
  .mobile-nav {
    z-index: 99;
    pointer-events: none;
    position: fixed;
    inset: 0;
  }

  .mobile-nav__tile {
    pointer-events: auto;
    background-color: var(--color-dark);
    flex-flow: column;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
    display: flex;
    position: absolute;
    top: 0;
    left: 0;
    transition: clip-path 1s cubic-bezier(.9, 0, .1, 1);
    clip-path: polygon(0% 0%, 100% 0%, 100% 0%, 0% 0%);
  }

  [data-navigation-status="active"] .mobile-nav__tile {
    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%);
  }

  .mobile-nav__list {
    flex-flow: column;
    align-items: center;
    margin: 0;
    padding: 0;
    display: flex;
    list-style: none;
  }

  .mobile-nav__item {
    justify-content: center;
    align-items: center;
    margin: 0;
    padding: 0;
    text-decoration: none;
    display: flex;
    position: relative;
    overflow: hidden;
    transition: opacity 0.5s cubic-bezier(.7, 0, .3, 1);
  }

  .mobile-nav__link {
    color: var(--color-white);
    letter-spacing: -0.04em;
    padding-left: 0.075em;
    padding-right: 0.075em;
    font-family: var(--font-heading);
    font-size: clamp(2rem, 8vw, 4rem);
    font-weight: 400;
    line-height: 1.2;
    text-decoration: none;
    transform: translateY(100%) rotate(5deg);
    transition: transform 0.75s cubic-bezier(.7, 0, .3, 1);
  }

  .mobile-nav__item:nth-child(1) .mobile-nav__link { transition-delay: 0.2s; }
  .mobile-nav__item:nth-child(2) .mobile-nav__link { transition-delay: 0.15s; }
  .mobile-nav__item:nth-child(3) .mobile-nav__link { transition-delay: 0.1s; }
  .mobile-nav__item:nth-child(4) .mobile-nav__link { transition-delay: 0.05s; }
  .mobile-nav__item:nth-child(5) .mobile-nav__link { transition-delay: 0s; }

  /* Links cuando nav activa */
  [data-navigation-status="active"] .mobile-nav__link {
    transform: translateY(0%) rotate(0.001deg);
    transition-delay: 0.3s;
  }

  [data-navigation-status="active"] .mobile-nav__item:nth-child(1) .mobile-nav__link { transition-delay: 0.3s; }
  [data-navigation-status="active"] .mobile-nav__item:nth-child(2) .mobile-nav__link { transition-delay: 0.35s; }
  [data-navigation-status="active"] .mobile-nav__item:nth-child(3) .mobile-nav__link { transition-delay: 0.4s; }
  [data-navigation-status="active"] .mobile-nav__item:nth-child(4) .mobile-nav__link { transition-delay: 0.45s; }
  [data-navigation-status="active"] .mobile-nav__item:nth-child(5) .mobile-nav__link { transition-delay: 0.5s; }

  .mobile-nav__link-text {
    text-shadow: 0 1.1em 0;
    display: block;
    position: relative;
    transition: transform 0.5s cubic-bezier(.7, 0, .3, 1);
    transform: translateY(0%) rotate(0.001deg);
  }

  /* Links hover efecto opacidad */
  .mobile-nav__list:has(.mobile-nav__item:hover) .mobile-nav__item {
    opacity: 0.15;
  }

  .mobile-nav__list:has(.mobile-nav__item:hover) .mobile-nav__item:hover {
    opacity: 1;
  }

  /* Links hover texto slide */
  .mobile-nav__link:hover .mobile-nav__link-text {
    transform: translateY(-100%) rotate(0.001deg);
  }

  /* Bottom */
  .mobile-nav__bottom {
    justify-content: center;
    align-items: center;
    width: 100%;
    padding: var(--space-lg);
    display: flex;
    position: absolute;
    bottom: 0;
    left: 0;
  }

  .mobile-nav__lang {
    font-family: var(--font-heading);
    font-size: 1rem;
    color: var(--color-white);
    opacity: 0.7;
    transition: opacity var(--transition-fast);

    &:hover {
      opacity: 1;
    }
  }

  /* ================================
     RESPONSIVE: Desktop >= 1220px
     ================================ */
  @media (min-width: 1220px) {
    .header {
      display: block;
    }

    .mobile-logo,
    .mobile-bar,
    .mobile-nav {
      display: none;
    }
  }
</style>

<script>
  // ================================
  // Scroll behavior (Desktop header + Mobile bar)
  // ================================
  const header = document.querySelector('.header');
  const mobileBar = document.querySelector('.mobile-bar');
  let lastScrollY = 0;
  const scrollThreshold = 50;

  function handleScroll() {
    const currentScrollY = window.scrollY;

    if (currentScrollY <= scrollThreshold) {
      // Estado top
      header?.classList.add('header--top');
      header?.classList.remove('header--scrolled');
      header?.classList.remove('header--hidden');

      mobileBar?.classList.add('mobile-bar--top');
      mobileBar?.classList.remove('mobile-bar--scrolled');
    } else {
      // Estado scrolled
      header?.classList.remove('header--top');
      header?.classList.add('header--scrolled');

      mobileBar?.classList.remove('mobile-bar--top');
      mobileBar?.classList.add('mobile-bar--scrolled');

      // Solo ocultar header desktop, mobile-bar siempre visible
      if (currentScrollY > lastScrollY) {
        header?.classList.add('header--hidden');
      } else {
        header?.classList.remove('header--hidden');
      }
    }

    lastScrollY = currentScrollY;
  }

  window.addEventListener('scroll', handleScroll);
  handleScroll();

  // ================================
  // Mobile Nav Fullscreen
  // ================================
  function initMobileNavigation() {
    const mobileBarEl = document.querySelector('.mobile-bar');

    function openMenu() {
      const navStatusEl = document.querySelector('[data-navigation-status]');
      if (!navStatusEl) return;
      navStatusEl.setAttribute('data-navigation-status', 'active');
      mobileBarEl?.classList.add('mobile-bar--menu-open');
      // Desactivar blend mode cuando el menú está abierto
      mobileBarEl?.classList.remove('mobile-bar--scrolled');
      mobileBarEl?.classList.add('mobile-bar--top');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      const navStatusEl = document.querySelector('[data-navigation-status]');
      if (!navStatusEl) return;
      navStatusEl.setAttribute('data-navigation-status', 'not-active');
      mobileBarEl?.classList.remove('mobile-bar--menu-open');
      document.body.style.overflow = '';
      // Re-evaluar estado de scroll
      handleScroll();
    }

    // Toggle Navigation
    document.querySelectorAll('[data-navigation-toggle="toggle"]').forEach(toggleBtn => {
      toggleBtn.addEventListener('click', () => {
        const navStatusEl = document.querySelector('[data-navigation-status]');
        if (!navStatusEl) return;

        if (navStatusEl.getAttribute('data-navigation-status') === 'not-active') {
          openMenu();
        } else {
          closeMenu();
        }
      });
    });

    // Close Navigation (para links del menú)
    document.querySelectorAll('[data-navigation-toggle="close"]').forEach(closeBtn => {
      closeBtn.addEventListener('click', closeMenu);
    });

    // ESC key - Close Navigation
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        const navStatusEl = document.querySelector('[data-navigation-status]');
        if (navStatusEl?.getAttribute('data-navigation-status') === 'active') {
          closeMenu();
        }
      }
    });
  }

  initMobileNavigation();
</script>
